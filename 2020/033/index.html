<!DOCTYPE html>
<html lang="zh-cn">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp" />
  
  <meta name="author" content="Pluto">
  
  <meta name="description" content="Pluto的博客">
  
  <meta name="keywords" content="blog, Hugo, Linux, Git, Manjaro">
  
  
  <link rel="prev" href="https://wbmins.github.io/2020/032/" />
  
  <link rel="next" href="https://wbmins.github.io/2020/034/" />
  <link rel="canonical" href="https://wbmins.github.io/2020/033/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#f5f5d5fff">
  <title>
    
    
    NIO 学习 | Pluto`s Blog
    
  </title>
  <meta name="title"
    content="NIO 学习 | Pluto`s Blog">
    
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/wbmins.github.io"
    },
    "articleSection" : "posts",
    "name" : "NIO 学习",
    "headline" : "NIO 学习",
    "description" : "1、简介 NIO支持面向缓冲区的、基于通道的IO操作. 2、与 IO 区别 IO NIO 面向流(Stream Oriented) 面向缓冲区(Buffer Oriented) 阻塞IO(Blockin",
    "inLanguage" : "zh-cn",
    "author" : "Pluto",
    "creator" : "Pluto",
    "publisher": "Pluto",
    "accountablePerson" : "Pluto",
    "copyrightHolder" : "Pluto",
    "copyrightYear" : "2020",
    "datePublished": "2020-03-27 19:37:52 \u002b0800 \u002b0800",
    "dateModified" : "2020-03-27 19:37:52 \u002b0800 \u002b0800",
    "url" : "https:\/\/wbmins.github.io\/2020\/033\/",
    "wordCount" : "2530",
    "keywords" : [ "Programing","Java", "Pluto`s Blog"]
}
</script>

</head>



  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    
    <div class="top-scroll-bar"></div>
    
    <div class="container">
        <div class="navbar-header header-back2home-logo">
            
            <span class="logo_mark">➜$ </span>
            <a href="https://wbmins.github.io">
                <span class="logo_text">cd /home/ </span>
                <span class="logo_cursor"></span>
            </a>
            
        </div>
        <div class="navbar-right">
            
            <span class="menu">
                
                <a class="menu-item"
                    href="/posts/" title="">Blog</a>
                
                <a class="menu-item"
                    href="/categories/" title="">Categories</a>
                
                <a class="menu-item"
                    href="/tags/" title="">Tags</a>
                
                <a class="menu-item"
                    href="/about/" title="">About</a>
                
                <a class="menu-item"
                    href="/mins/" title="">Mins</a>
                
            </span>
            <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-dark-mode"></i></a>
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
    
    <div class="top-scroll-bar"></div>
    
    <div class="container">
        <div class="navbar-header">
            <div class="header-logo">
                
                <span class="logo_mark">></span>
                <a href="https://wbmins.github.io">
                    <span class="logo_text">$ cd /home/ </span>
                    <span class="logo_cursor"></span>
                </a>
                
            </div>
            <div class="navbar-right">
                <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-dark-mode"></i></a>
                <div class="menu-toggle">
                    <span></span><span></span><span></span>
                </div>
            </div>
        </div>

        <div class="menu" id="mobile-menu">
            
            
            <a class="menu-item"
                href="/posts/" title="">Blog</a>
            
            <a class="menu-item"
                href="/categories/" title="">Categories</a>
            
            <a class="menu-item"
                href="/tags/" title="">Tags</a>
            
            <a class="menu-item"
                href="/about/" title="">About</a>
            
            <a class="menu-item"
                href="/mins/" title="">Mins</a>
            
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title"></h2>
  
  <div
    class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#1简介">1、简介</a></li>
    <li><a href="#2与-io-区别">2、与 IO 区别</a></li>
    <li><a href="#3缓冲区channel-传输和通道buffer存储">3、缓冲区(channel 传输)和通道(buffer　存储)</a></li>
    <li><a href="#4文件通道">4、文件通道</a></li>
    <li><a href="#5非阻塞网络通信nio2">5、非阻塞网络通信(NIO2)</a></li>
  </ul>
</nav>
  </div>
</div>
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">NIO 学习</h1>
        <div class="post-meta">
            Written by <a itemprop="name" href="https://wbmins.github.io"
                rel="author">Pluto</a>
            with ♥
            <span class="post-time">
                on <time datetime=2020-03-27
                    itemprop="datePublished">March 27, 2020</time>
            </span>
            in
            <i class="iconfont icon-folder"></i>
            <span class="post-category">
                <a href="https://wbmins.github.io/categories/%E5%85%A5%E5%9D%9F/"> 入坟 </a>
                
            </span>
            <span class="post-word-count">,2530 words</span>
            <span class="post-read-time">,read need 6 min</span>
        </div>
    </header>
    <div class="post-content">
        

        

        
        

        
        
        

        
        
        

        <h2 id="1简介">1、简介</h2>
<blockquote>
<p>NIO支持面向缓冲区的、基于通道的IO操作.</p>
</blockquote>
<h2 id="2与-io-区别">2、与 IO 区别</h2>
<table>
<thead>
<tr>
<th>IO</th>
<th>NIO</th>
</tr>
</thead>
<tbody>
<tr>
<td>面向流(Stream Oriented)</td>
<td>面向缓冲区(Buffer Oriented)</td>
</tr>
<tr>
<td>阻塞IO(Blocking IO)</td>
<td>非阻塞IO(Non Blocking IO)</td>
</tr>
<tr>
<td>无</td>
<td>选择器(Selectors)</td>
</tr>
</tbody>
</table>
<h2 id="3缓冲区channel-传输和通道buffer存储">3、缓冲区(channel 传输)和通道(buffer　存储)</h2>
<ul>
<li>通道(buffer)标识打开到IO设备(文件、套接字)的连接.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestBuffer</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * 1.缓冲区
</span><span style="color:#75715e">     * ByteBuffer
</span><span style="color:#75715e">     * CharBuffer
</span><span style="color:#75715e">     * ShortBuffer
</span><span style="color:#75715e">     * IntBuffer
</span><span style="color:#75715e">     * LongBuffer
</span><span style="color:#75715e">     * FloatBuffer
</span><span style="color:#75715e">     * DoubleBuffer
</span><span style="color:#75715e">     * 同意通过allocate()获取
</span><span style="color:#75715e">     * 2.缓冲区存取数据核心方法
</span><span style="color:#75715e">     * put()
</span><span style="color:#75715e">     * get()
</span><span style="color:#75715e">     * 3.四个核心属性
</span><span style="color:#75715e">     * capacity:缓冲区最大存储数量,一旦声明不能改变
</span><span style="color:#75715e">     * limit:表示缓冲区可以操作数据的大小
</span><span style="color:#75715e">     * position:表示缓冲区正在操作数据的位置
</span><span style="color:#75715e">     * 0 &lt;= position &lt;= limit &lt;= capacity
</span><span style="color:#75715e">     * mark:标记position位置通过reset()回答mark位置
</span><span style="color:#75715e">     * 4.直接缓冲区于非直接缓冲区
</span><span style="color:#75715e">     * 非直接缓冲区:通过allocate方法分配,建立在jvm内存中
</span><span style="color:#75715e">     * 直接缓冲区:通过allocateDirect()分配,建立在物理内存中,
</span><span style="color:#75715e">     * 可以提高效率
</span><span style="color:#75715e">     */</span>
    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">test</span><span style="color:#f92672">(){</span>
        String str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;qwerty&#34;</span><span style="color:#f92672">;</span>
        ByteBuffer byteBuffer <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span>1024<span style="color:#f92672">);</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;1.分配指定大小缓冲区---allocate---&#34;</span><span style="color:#f92672">);</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">position</span><span style="color:#f92672">());</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">limit</span><span style="color:#f92672">());</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">capacity</span><span style="color:#f92672">());</span>

        byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>str<span style="color:#f92672">.</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">());</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2.put存数据到缓冲区---put---&#34;</span><span style="color:#f92672">);</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">position</span><span style="color:#f92672">());</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">limit</span><span style="color:#f92672">());</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">capacity</span><span style="color:#f92672">());</span>

        byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">flip</span><span style="color:#f92672">();</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;3.切换读数据模式---flip---&#34;</span><span style="color:#f92672">);</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">position</span><span style="color:#f92672">());</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">limit</span><span style="color:#f92672">());</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">capacity</span><span style="color:#f92672">());</span>

        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bytes <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">limit</span><span style="color:#f92672">()];</span>
        byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>bytes<span style="color:#f92672">);</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>bytes<span style="color:#f92672">,</span>0<span style="color:#f92672">,</span>bytes<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">));</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;4.get读取数据---get---&#34;</span><span style="color:#f92672">);</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">position</span><span style="color:#f92672">());</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">limit</span><span style="color:#f92672">());</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">capacity</span><span style="color:#f92672">());</span>

        byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">rewind</span><span style="color:#f92672">();</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;5.可重复读---rewind---&#34;</span><span style="color:#f92672">);</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">position</span><span style="color:#f92672">());</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">limit</span><span style="color:#f92672">());</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">capacity</span><span style="color:#f92672">());</span>

        byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">//但数据还在,处于被遗忘状态
</span><span style="color:#75715e"></span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;6.清除缓冲区---clear---&#34;</span><span style="color:#f92672">);</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">position</span><span style="color:#f92672">());</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">limit</span><span style="color:#f92672">());</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">capacity</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>使用NIO系统,需要获取用于连接IO设备的通道以及用于容纳数据的缓冲区,然后操作缓冲区,对数据进行处理.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestChannel</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * 1.通道和目标节点的连接,负责数据的传输.本身不存储数据
</span><span style="color:#75715e">     * 2.主要实现类
</span><span style="color:#75715e">     * java.nio.channels.channel
</span><span style="color:#75715e">     * |--FileChannel           本地
</span><span style="color:#75715e">     * |--SocketChannel　      网络(tcp)
</span><span style="color:#75715e">     * |--ServerSocketChannel  网络(tcp)
</span><span style="color:#75715e">     * |--DatagramChannel      网络(udp)
</span><span style="color:#75715e">     * 3.1获取通道getChannel()
</span><span style="color:#75715e">     * 本地IO
</span><span style="color:#75715e">     * 　   |--FileInputStream/FileOutputStream
</span><span style="color:#75715e">     * |--RandomAcessFile
</span><span style="color:#75715e">     * 网络IO
</span><span style="color:#75715e">     * 　   |--Socket
</span><span style="color:#75715e">     * |--ServerSocket
</span><span style="color:#75715e">     * |--DatagramSocket
</span><span style="color:#75715e">     * 3.2 jdk nio2
</span><span style="color:#75715e">     * |--通道提供的静态方法open()
</span><span style="color:#75715e">     * |--Files工具类提供的newByteChannel()
</span><span style="color:#75715e">     * 4.通道之间的数据传输
</span><span style="color:#75715e">     * |--transferFrom
</span><span style="color:#75715e">     * |--transferTo
</span><span style="color:#75715e">     * 5.分散和聚集
</span><span style="color:#75715e">     * |--分散读取scatter reads 通道数据分散多个缓冲区
</span><span style="color:#75715e">     * |--聚集写入gather writes　将多个缓冲区聚集到一个通道中
</span><span style="color:#75715e">     * 6.字符集
</span><span style="color:#75715e">     * |--字符串到字符数据
</span><span style="color:#75715e">     * |--字符数据到字符串
</span><span style="color:#75715e">     */</span>
    <span style="color:#75715e">//字符集
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">test6</span><span style="color:#f92672">(){</span>
        Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Charset<span style="color:#f92672">&gt;</span> map <span style="color:#f92672">=</span> Charset<span style="color:#f92672">.</span><span style="color:#a6e22e">availableCharsets</span><span style="color:#f92672">();</span>
        Set<span style="color:#f92672">&lt;</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span>Charset<span style="color:#f92672">&gt;&gt;</span> set <span style="color:#f92672">=</span> map<span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span>Charset<span style="color:#f92672">&gt;</span> entry <span style="color:#f92672">:</span> set<span style="color:#f92672">){</span>
            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">()+</span><span style="color:#e6db74">&#34;===&#34;</span><span style="color:#f92672">+</span>entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">//分散读取聚集写入
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">test5</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
        RandomAccessFile raf <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RandomAccessFile<span style="color:#f92672">(</span>
                <span style="color:#e6db74">&#34;/home/pluto/Download/1.jpg&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;rw&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">//获取通道
</span><span style="color:#75715e"></span>        FileChannel fileChannel <span style="color:#f92672">=</span> raf<span style="color:#f92672">.</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>

        <span style="color:#75715e">//分配指定大小缓冲区
</span><span style="color:#75715e"></span>        ByteBuffer byteBuffer <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span>600<span style="color:#f92672">);</span>
        ByteBuffer byteBuffer1 <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span>1024<span style="color:#f92672">);</span>

        <span style="color:#75715e">//分散读取
</span><span style="color:#75715e"></span>        ByteBuffer<span style="color:#f92672">[]</span> bf <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>byteBuffer<span style="color:#f92672">,</span>byteBuffer1<span style="color:#f92672">};</span>
        <span style="color:#75715e">//fileChannel.read(bf);
</span><span style="color:#75715e"></span>
        <span style="color:#75715e">//聚集写入
</span><span style="color:#75715e"></span>        RandomAccessFile randomAccessFile <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RandomAccessFile<span style="color:#f92672">(</span>
                <span style="color:#e6db74">&#34;/home/pluto/Download/2.jpg&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;rw&#34;</span><span style="color:#f92672">);</span>
        FileChannel fileChannel1 <span style="color:#f92672">=</span> randomAccessFile<span style="color:#f92672">.</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
        fileChannel1<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>bf<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">//通道数据传输(直接缓冲区)
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">test3</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
        FileChannel infileChannel <span style="color:#f92672">=</span> FileChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">(</span>Paths<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>
                <span style="color:#e6db74">&#34;/home/pluto/Download/1.jpg&#34;</span><span style="color:#f92672">),</span> StandardOpenOption<span style="color:#f92672">.</span><span style="color:#a6e22e">READ</span><span style="color:#f92672">);</span>
        FileChannel outfileChannle <span style="color:#f92672">=</span> FileChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">(</span>Paths<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>
                <span style="color:#e6db74">&#34;/home/pluto/Download/3.jpg&#34;</span><span style="color:#f92672">),</span>
                StandardOpenOption<span style="color:#f92672">.</span><span style="color:#a6e22e">WRITE</span><span style="color:#f92672">,</span> StandardOpenOption<span style="color:#f92672">.</span><span style="color:#a6e22e">READ</span><span style="color:#f92672">,</span>
                StandardOpenOption<span style="color:#f92672">.</span><span style="color:#a6e22e">CREATE</span><span style="color:#f92672">);</span>

        infileChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">transferTo</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> infileChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">(),</span> outfileChannle<span style="color:#f92672">);</span><span style="color:#75715e">//下面和这一行效果一样
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//outfileChannle.transferFrom(infileChannel,0,infileChannel.size());
</span><span style="color:#75715e"></span>        infileChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
        outfileChannle<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">//使用直接缓冲区完成文件复制(内存映射文件)
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">test1</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
        FileChannel infileChannel <span style="color:#f92672">=</span> FileChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">(</span>Paths<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>
                <span style="color:#e6db74">&#34;/home/pluto/Download/1.jpg&#34;</span><span style="color:#f92672">),</span> StandardOpenOption<span style="color:#f92672">.</span><span style="color:#a6e22e">READ</span><span style="color:#f92672">);</span>
        FileChannel outfileChannle <span style="color:#f92672">=</span> FileChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">(</span>Paths<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>
                <span style="color:#e6db74">&#34;/home/pluto/Download/3.jpg&#34;</span><span style="color:#f92672">),</span> StandardOpenOption<span style="color:#f92672">.</span><span style="color:#a6e22e">WRITE</span><span style="color:#f92672">,</span>
                StandardOpenOption<span style="color:#f92672">.</span><span style="color:#a6e22e">READ</span><span style="color:#f92672">,</span> StandardOpenOption<span style="color:#f92672">.</span><span style="color:#a6e22e">CREATE</span><span style="color:#f92672">);</span>

        <span style="color:#75715e">//内存映射文件
</span><span style="color:#75715e"></span>        MappedByteBuffer inmapbufer <span style="color:#f92672">=</span> infileChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">map</span><span style="color:#f92672">(</span>
                FileChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">MapMode</span><span style="color:#f92672">.</span><span style="color:#a6e22e">READ_ONLY</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> infileChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">());</span>
        MappedByteBuffer outmapbufer <span style="color:#f92672">=</span> outfileChannle<span style="color:#f92672">.</span><span style="color:#a6e22e">map</span><span style="color:#f92672">(</span>
                FileChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">MapMode</span><span style="color:#f92672">.</span><span style="color:#a6e22e">READ_WRITE</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> infileChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">());</span>

        <span style="color:#75715e">//直接对缓冲区进行读写
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> by <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[</span>inmapbufer<span style="color:#f92672">.</span><span style="color:#a6e22e">limit</span><span style="color:#f92672">()];</span>
        inmapbufer<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>by<span style="color:#f92672">);</span>
        outmapbufer<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>by<span style="color:#f92672">);</span>
        infileChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
        outfileChannle<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">//利用通道完成文件的复制(非直接缓冲区)
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">test</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        FileInputStream fio <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        FileOutputStream foo <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        FileChannel channeli <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        FileChannel channelo <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            fio <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileInputStream<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/home/pluto/Download/1.jpg&#34;</span><span style="color:#f92672">);</span>
            foo <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileOutputStream<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/home/pluto/Download/2.jpg&#34;</span><span style="color:#f92672">);</span>
            <span style="color:#75715e">//1.获取通道
</span><span style="color:#75715e"></span>            channeli <span style="color:#f92672">=</span> fio<span style="color:#f92672">.</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
            channelo <span style="color:#f92672">=</span> foo<span style="color:#f92672">.</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">//2.分配指定大小缓冲区
</span><span style="color:#75715e"></span>            ByteBuffer byteBuffer <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span>1024<span style="color:#f92672">);</span>
            <span style="color:#75715e">//3.通道数据存入缓冲区
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>channeli<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">flip</span><span style="color:#f92672">();</span> <span style="color:#75715e">//切换读模式
</span><span style="color:#75715e"></span>                channelo<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">);</span><span style="color:#75715e">//缓冲区数据写入通道
</span><span style="color:#75715e"></span>                byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span><span style="color:#75715e">//清空缓冲区
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>channelo <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    channelo<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>channeli <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    channeli<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>foo <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    foo<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fio <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    fio<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="4文件通道">4、文件通道</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestBlocking</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * 使用nio核心
</span><span style="color:#75715e">     * - 通道连接channel
</span><span style="color:#75715e">     * java.nio.channels.channel
</span><span style="color:#75715e">     *  * |--FileChannel           本地
</span><span style="color:#75715e">     *  * |--SocketChannel　      网络(tcp)
</span><span style="color:#75715e">     *  * |--ServerSocketChannel  网络(tcp)
</span><span style="color:#75715e">     *  * |--DatagramChannel      网络(udp)
</span><span style="color:#75715e">     *  * |--Pipe.SinkChannel
</span><span style="color:#75715e">     *  * |--Pipe.SourceChannel
</span><span style="color:#75715e">     * - 缓冲区存数据buffer
</span><span style="color:#75715e">     * - 选择器selecttablechannel的多路复用器,用于监控复用器io状况
</span><span style="color:#75715e">     */</span>
    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">client</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
        <span style="color:#75715e">//客户端
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//获取通道
</span><span style="color:#75715e"></span>        SocketChannel socketChannel <span style="color:#f92672">=</span> SocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">(</span>
                <span style="color:#66d9ef">new</span> InetSocketAddress<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;127.0.0.1&#34;</span><span style="color:#f92672">,</span>9999<span style="color:#f92672">));</span>
        FileChannel inf <span style="color:#f92672">=</span> FileChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">(</span>Paths<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>
                <span style="color:#e6db74">&#34;/home/pluto/Download/1.jpg&#34;</span><span style="color:#f92672">),</span> StandardOpenOption<span style="color:#f92672">.</span><span style="color:#a6e22e">READ</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">//分配指定大小缓冲区
</span><span style="color:#75715e"></span>        ByteBuffer byteBuffers <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span>1024<span style="color:#f92672">*</span>1024<span style="color:#f92672">*</span>4<span style="color:#f92672">);</span>

        <span style="color:#75715e">//读取文件发送到服务端
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>inf<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>byteBuffers<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">){</span>
            byteBuffers<span style="color:#f92672">.</span><span style="color:#a6e22e">flip</span><span style="color:#f92672">();</span>
            socketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>byteBuffers<span style="color:#f92672">);</span>
            byteBuffers<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">//关闭通道
</span><span style="color:#75715e"></span>        socketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>

    <span style="color:#f92672">}</span>
    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">server</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
        <span style="color:#75715e">//服务端
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//获取通道
</span><span style="color:#75715e"></span>        ServerSocketChannel serverSocketChannel <span style="color:#f92672">=</span> ServerSocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">();</span>
        FileChannel outf <span style="color:#f92672">=</span> FileChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">(</span>Paths<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>
                <span style="color:#e6db74">&#34;/home/pluto/Download/2.jpg&#34;</span><span style="color:#f92672">),</span>
                StandardOpenOption<span style="color:#f92672">.</span><span style="color:#a6e22e">WRITE</span><span style="color:#f92672">,</span>StandardOpenOption<span style="color:#f92672">.</span><span style="color:#a6e22e">CREATE</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">//绑定端口
</span><span style="color:#75715e"></span>        serverSocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">bind</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> InetSocketAddress<span style="color:#f92672">(</span>9999<span style="color:#f92672">));</span>
        <span style="color:#75715e">//获取客户端连接通道
</span><span style="color:#75715e"></span>        SocketChannel socketChannel <span style="color:#f92672">=</span> serverSocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">accept</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">//分配指定大小缓冲区
</span><span style="color:#75715e"></span>        ByteBuffer buf <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span>1024<span style="color:#f92672">*</span>1024<span style="color:#f92672">*</span>4<span style="color:#f92672">);</span>
        <span style="color:#75715e">//读取客户端数据
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span><span style="color:#f92672">(</span>socketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>buf<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">){</span>
            buf<span style="color:#f92672">.</span><span style="color:#a6e22e">flip</span><span style="color:#f92672">();</span>
            outf<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>buf<span style="color:#f92672">);</span>
            buf<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">//关闭
</span><span style="color:#75715e"></span>        socketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
        buf<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
        serverSocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>

    <span style="color:#f92672">}</span>
    <span style="color:#a6e22e">@Test</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">client1</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
        <span style="color:#75715e">//客户端
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//获取通道
</span><span style="color:#75715e"></span>        SocketChannel socketChannel <span style="color:#f92672">=</span> SocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">(</span>
                <span style="color:#66d9ef">new</span> InetSocketAddress<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;127.0.0.1&#34;</span><span style="color:#f92672">,</span>8888<span style="color:#f92672">));</span>
        FileChannel inf <span style="color:#f92672">=</span> FileChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">(</span>Paths<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>
                <span style="color:#e6db74">&#34;/home/pluto/Download/1.jpg&#34;</span><span style="color:#f92672">),</span> StandardOpenOption<span style="color:#f92672">.</span><span style="color:#a6e22e">READ</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">//分配指定大小缓冲区
</span><span style="color:#75715e"></span>        ByteBuffer byteBuffers <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span>1024<span style="color:#f92672">);</span>

        <span style="color:#75715e">//读取文件发送到服务端
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>inf<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>byteBuffers<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">){</span>
            byteBuffers<span style="color:#f92672">.</span><span style="color:#a6e22e">flip</span><span style="color:#f92672">();</span>
            socketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>byteBuffers<span style="color:#f92672">);</span>
            byteBuffers<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">//告诉服务端我发挖了
</span><span style="color:#75715e"></span>        socketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">shutdownOutput</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">//接收服务器端反馈
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> len <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">while</span><span style="color:#f92672">((</span>len <span style="color:#f92672">=</span> socketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>byteBuffers<span style="color:#f92672">))</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">){</span>
            byteBuffers<span style="color:#f92672">.</span><span style="color:#a6e22e">flip</span><span style="color:#f92672">();</span>
            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>byteBuffers<span style="color:#f92672">.</span><span style="color:#a6e22e">array</span><span style="color:#f92672">(),</span>0<span style="color:#f92672">,</span>len<span style="color:#f92672">));</span>
            byteBuffers<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">//关闭通道
</span><span style="color:#75715e"></span>        inf<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
        socketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">server1</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
        <span style="color:#75715e">//服务端
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//获取通道
</span><span style="color:#75715e"></span>        ServerSocketChannel serverSocketChannel <span style="color:#f92672">=</span> ServerSocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">();</span>
        FileChannel outf <span style="color:#f92672">=</span> FileChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">(</span>Paths<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>
                <span style="color:#e6db74">&#34;/home/pluto/Download/2.jpg&#34;</span><span style="color:#f92672">),</span>
                StandardOpenOption<span style="color:#f92672">.</span><span style="color:#a6e22e">WRITE</span><span style="color:#f92672">,</span>StandardOpenOption<span style="color:#f92672">.</span><span style="color:#a6e22e">CREATE</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">//绑定端口
</span><span style="color:#75715e"></span>        serverSocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">bind</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> InetSocketAddress<span style="color:#f92672">(</span>8888<span style="color:#f92672">));</span>
        <span style="color:#75715e">//获取客户端连接通道
</span><span style="color:#75715e"></span>        SocketChannel socketChannel <span style="color:#f92672">=</span> serverSocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">accept</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">//分配指定大小缓冲区
</span><span style="color:#75715e"></span>        ByteBuffer buf <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span>1024<span style="color:#f92672">);</span>
        <span style="color:#75715e">//读取客户端数据
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span><span style="color:#f92672">(</span>socketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>buf<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">){</span>
            buf<span style="color:#f92672">.</span><span style="color:#a6e22e">flip</span><span style="color:#f92672">();</span>
            outf<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>buf<span style="color:#f92672">);</span>
            buf<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">//发送反馈
</span><span style="color:#75715e"></span>        buf<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;服务端就收数据成功&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">());</span>
        buf<span style="color:#f92672">.</span><span style="color:#a6e22e">flip</span><span style="color:#f92672">();</span>
        socketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>buf<span style="color:#f92672">);</span>
        <span style="color:#75715e">//关闭
</span><span style="color:#75715e"></span>        socketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
        outf<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
        serverSocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="5非阻塞网络通信nio2">5、非阻塞网络通信(NIO2)</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestNonBlocking</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">client</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
        <span style="color:#75715e">//客户端
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//获取通道
</span><span style="color:#75715e"></span>        SocketChannel ssChannel <span style="color:#f92672">=</span> SocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">(</span>
                <span style="color:#66d9ef">new</span> InetSocketAddress<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;127.0.0.1&#34;</span><span style="color:#f92672">,</span>8888<span style="color:#f92672">));</span>
        <span style="color:#75715e">//切换非阻塞模式
</span><span style="color:#75715e"></span>        ssChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">configureBlocking</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">//分配指定大小缓冲区
</span><span style="color:#75715e"></span>        ByteBuffer bf <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span>1024<span style="color:#f92672">);</span>
        <span style="color:#75715e">//发送数据
</span><span style="color:#75715e"></span>        Scanner scanner <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Scanner<span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">in</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>scanner<span style="color:#f92672">.</span><span style="color:#a6e22e">hasNext</span><span style="color:#f92672">()){</span>
            String str <span style="color:#f92672">=</span> scanner<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">();</span>
            bf<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">((</span><span style="color:#66d9ef">new</span> Date<span style="color:#f92672">().</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">()+</span>str<span style="color:#f92672">).</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">());</span>
            bf<span style="color:#f92672">.</span><span style="color:#a6e22e">flip</span><span style="color:#f92672">();</span>
            ssChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>bf<span style="color:#f92672">);</span>
            bf<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
<span style="color:#75715e">//        bf.put(new Date().toString().getBytes());
</span><span style="color:#75715e">//        bf.flip();
</span><span style="color:#75715e">//        ssChannel.write(bf);
</span><span style="color:#75715e">//        bf.clear();
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//关闭通道
</span><span style="color:#75715e"></span>        ssChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">server</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
        <span style="color:#75715e">//服务端
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//获取通道
</span><span style="color:#75715e"></span>        ServerSocketChannel ssChannel <span style="color:#f92672">=</span> ServerSocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">//q切换非阻塞
</span><span style="color:#75715e"></span>        ssChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">configureBlocking</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">//绑定
</span><span style="color:#75715e"></span>        ssChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">bind</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> InetSocketAddress<span style="color:#f92672">(</span>8888<span style="color:#f92672">));</span>
        <span style="color:#75715e">//获取选择器
</span><span style="color:#75715e"></span>        Selector selector <span style="color:#f92672">=</span> Selector<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">//通道注册到注册选择器,并指定监听事件
</span><span style="color:#75715e"></span>        ssChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>selector<span style="color:#f92672">,</span> SelectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">OP_ACCEPT</span><span style="color:#f92672">);</span>
        <span style="color:#75715e">//轮巡式获取已经准备就绪的选择器
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>selector<span style="color:#f92672">.</span><span style="color:#a6e22e">select</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">){</span>
            <span style="color:#75715e">//获取选中当前选择器注册的选择键
</span><span style="color:#75715e"></span>            Iterator<span style="color:#f92672">&lt;</span>SelectionKey<span style="color:#f92672">&gt;</span> iterator <span style="color:#f92672">=</span> selector<span style="color:#f92672">.</span><span style="color:#a6e22e">selectedKeys</span><span style="color:#f92672">().</span><span style="color:#a6e22e">iterator</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>iterator<span style="color:#f92672">.</span><span style="color:#a6e22e">hasNext</span><span style="color:#f92672">()){</span>
                <span style="color:#75715e">//获取准备就绪的事件
</span><span style="color:#75715e"></span>                SelectionKey skey <span style="color:#f92672">=</span> iterator<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">();</span>
                <span style="color:#75715e">//判断具体是什么事件准备就绪
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>skey<span style="color:#f92672">.</span><span style="color:#a6e22e">isAcceptable</span><span style="color:#f92672">()){</span>
                    <span style="color:#75715e">//若就收就绪,获取客户端连接
</span><span style="color:#75715e"></span>                    SocketChannel sChannel <span style="color:#f92672">=</span> ssChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">accept</span><span style="color:#f92672">();</span>
                    <span style="color:#75715e">//切换非阻塞模式
</span><span style="color:#75715e"></span>                    sChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">configureBlocking</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
                    <span style="color:#75715e">//通道注册到选择器
</span><span style="color:#75715e"></span>                    sChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>selector<span style="color:#f92672">,</span>SelectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">OP_READ</span><span style="color:#f92672">);</span>

                <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>skey<span style="color:#f92672">.</span><span style="color:#a6e22e">isReadable</span><span style="color:#f92672">()){</span>
                    SocketChannel sChannel <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>SocketChannel<span style="color:#f92672">)</span>skey<span style="color:#f92672">.</span><span style="color:#a6e22e">channel</span><span style="color:#f92672">();</span>
                    <span style="color:#75715e">//读取数据
</span><span style="color:#75715e"></span>                    ByteBuffer bf <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span>1024<span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">int</span> len <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">while</span> <span style="color:#f92672">((</span>len <span style="color:#f92672">=</span> sChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>bf<span style="color:#f92672">))</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">){</span>
                        bf<span style="color:#f92672">.</span><span style="color:#a6e22e">flip</span><span style="color:#f92672">();</span>
                        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>bf<span style="color:#f92672">.</span><span style="color:#a6e22e">array</span><span style="color:#f92672">(),</span>0<span style="color:#f92672">,</span>len<span style="color:#f92672">));</span>
                        bf<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">//用完取消选择键
</span><span style="color:#75715e"></span>            iterator<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div>
    </div>

    <div class="post-copyright">
        
        <p class="copyright-item">
            <span>Author:</span>
            <span>Pluto </span>
        </p>
        

        
        <p class="copyright-item">
            <span>Link:</span>
            <a href=https://wbmins.github.io/2020/033/>https://wbmins.github.io/2020/033/</span>
        </p>
        
        
        <p class="copyright-item lincese">
            本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
        </p>
        
    </div>


    <div class="post-tags">
        
        <section>
            <i class="iconfont icon-tag"></i>Tag(s):
            
            <span class="tag"><a href="https://wbmins.github.io/tags/programing/">
                    #Programing</a></span>
            
            <span class="tag"><a href="https://wbmins.github.io/tags/java/">
                    #Java</a></span>
            
        </section>
        
        <section>
            <a href="javascript:window.history.back();">back</a></span> ·
            <span><a href="https://wbmins.github.io">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://wbmins.github.io/2020/032/" class="prev" rel="prev" title="Emoji 使用"><i
                class="iconfont icon-left"></i>&nbsp;Emoji 使用</a>
        
        
        <a href="https://wbmins.github.io/2020/034/" class="next" rel="next"
            title="MySQL 深入">MySQL 深入&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
        
        
        
<script src="https://utteranc.es/client.js" repo="wbmins/blog-comment" issue-term="pathname" theme="github-light"
    crossorigin="anonymous" async>
    </script>

        
        
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
   <div class="copyright">
      &copy;
      
      <span itemprop="copyrightYear">2017 - 2021</span>
      <span>&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="heart-icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;</span>

      
      <span class="author" itemprop="copyrightHolder"><a href="https://wbmins.github.io">Pluto</a> |
      </span>
      

      
      <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a
            href="https://github.com/wbmins/violet" target="_blank" rel="external nofollow">Violet</a></span>
   </div>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js"></script>
<script> pangu.spacingPage();  </script>










<script src="/js/vendor_no_gallery.min.js" async=""></script>





     </div>
  </body>
</html>
